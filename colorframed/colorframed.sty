% colorframed.sty    v0.9    2022/09/20 
% Copyright (c) 2022 Jean-Fran√ßois B.
% Distributed under the terms of the LPPL 1.3c, see README.md
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{colorframed}
    [2022/09/20 v0.9 coloured `framed' and `pict2e' based breakable boxes (JFB)]
\RequirePackage{framed}
\RequirePackage{color}
\expandafter\def\expandafter\MakeFramed\expandafter#\expandafter1\expandafter
  {\MakeFramed{#1}\color@begingroup}
\expandafter\def\expandafter\endMakeFramed\expandafter
  {\expandafter\color@endgroup\endMakeFramed}
% This is expanded by framed.sty only in local scopes and with argument a
% box, so it has no impact on the user \fbox or \framebox.
\def\FrameCommand{\let\@frameb@x\colorframed@frameb@x
    \setlength\fboxrule{\FrameRule}\setlength\fboxsep{\FrameSep}\fbox}
% This is downgraded from a much more general framing macro, which was
% designed to add the framing in a way not modifying horizontal dimensions
% of contents.  So I needed to do both trimming and modifications which
% accumulate to some certainly sub-optimal final result.
% (perhaps this will be revisited at a later date)
%
% Regarding pagebreaks the important thing here is to draw the frame first
% as the \@tempboxa may well contain an unpaired color push.  And we need
% to reset the colour when drawing the frame else the frame on top of next
% page may be under influence of a color push from the box contents on
% previous page.
%
% TODO: do actually test this does work as expected with \@iframebox, but
% as we inject this only in the \fbox used by the framed.sty default
% \FrameCommand, the support code here is not strictly speaking necessary.
\def\colorframedbordercolorcommand{\normalcolor}
\def\colorframed@frameb@x#1{\hbox{%
    \ht\@tempboxa
       \dimexpr\ht\@tempboxa+\fboxrule+\fboxsep\relax
    \dp\@tempboxa
       \dimexpr\dp\@tempboxa+\fboxrule+\fboxsep\relax
    % BOX BORDER
        \setbox\z@\hbox
                  {\vrule\@width\fboxrule
                   #1%
                   \kern\wd\@tempboxa
                   #1%
                   \vrule\@width\fboxrule
                  }%
            \ht\z@\ht\@tempboxa
            \dp\z@\dp\@tempboxa
    \vbox{%
        \colorframedbordercolorcommand
        \hrule\@height\fboxrule\kern-\fboxrule
        \copy\z@
        \kern-\fboxrule
        \hrule\@height\fboxrule
        \kern-\dp\@tempboxa
       }%
    \kern-\wd\z@
    \kern\fboxrule
    #1% either \relax or \kern-\fboxrule
    % CONTENTS
    \box\@tempboxa
    #1%
    \kern\fboxrule
  }%
}
\AtBeginDocument{\PackageInfo{colorframed}
  {framed.sty macros \string\MakeFramed\space and \string\endMakeFramed,\MessageBreak
   as well as the default \string\FrameCommand\space (`framed') and\MessageBreak
   the internal \string\CustomFBox\space (`oframed', `titled-frame')\MessageBreak
   have been modified to fix colour leaks issues.\MessageBreak
   This works with all engines,\MessageBreak
   as no extra `color stack' is needed\@gobble}}
\endinput
