\documentclass[a4paper,dvipdfmx,10pt,english]{article}
\usepackage{babel}
\usepackage[T1]{fontenc}
\usepackage{geometry}
\usepackage[straightquotes,ttzdefault]{newtxtt}
\usepackage{framed}
\usepackage[dvipsnames]{xcolor}
\usepackage{colorframed}
% we put this here but it does not have to be in preamble of
% course
% titled-frame
\colorlet{TFFrameColor}{teal!20}
\colorlet{TFTitleColor}{purple}
\def\colorframedTFconlabcolorcommand{\color{purple}}
% shaded
\colorlet{shadecolor}{orange!10}
% framed
\FrameRule5pt\relax
\FrameSep9pt\relax % this is framed.sty default anyhow, 3\fboxsep
% attention that \FrameSep influences framed but also shaded, shaded* and
% oframed, which is not so clear from reading only framed documentation
\def\colorframedbordercolorcommand{\color{red!20}}

\title{The \colorframed package%
\vadjust{\vtop to 0pt{\hbox
    to\linewidth{\strut\footnotesize Release 0.9b of
      2022/10/01\hss report issues at \url{https://github.com/jfbu/colorframed}}\vss}}%
}
\author{Jean-François B.}
\date{}
\usepackage{shortvrb}\MakeShortVerb\|
%\usepackage{url}\urlstyle{same}
\usepackage{hyperref}
\def\ctanpackage#1{\href{https://ctan.org/pkg/#1}{#1}}

\usepackage{amssymb}

\usepackage{parskip}
\usepackage{xspace}
\usepackage{metalogo}
\setlogokern{La}{-0.258em}
\setlogokern{aT}{-0.08em}
\setlogokern{eL}{-0.1em}
%\setlogokern{X2}{0em}
\usepackage{enumitem}

\definecolor{joli}{RGB}{225,95,0}
\definecolor{JOLI}{RGB}{225,95,0}
\newcommand\colorframed{%
        \texorpdfstring{{\color{joli}\bfseries colorframed}}{colorframed}\xspace}


% ATTENTION: dvipdfmx syntax here!
{\makeatletter
     \sbox0{\color{RawSienna}%
            \xdef\verbatimpushcolor{\special{color push \current@color}}}%
}
\def\verbatimpopcolor{\special{color pop}}
\AddToHook{env/verbatim/before}{\verbatimpushcolor}
\AddToHook{env/verbatim/end}{\verbatimpopcolor}

\newcommand\ghissue[2][]{\href{https://github.com/jfbu/colorframed/issues/#2}{#1\##2}}

\begin{document}
\maketitle

\vskip-1.75\baselineskip

{\footnotesize
\halign{\tabskip1em\bfseries#\unskip&\hfil(#\unskip)\hfil&#\unskip\hfil\cr
0.9  & 2022/09/22 & initial release\cr
0.9a & 2022/09/23 & doc fixes, mention \ctanpackage{longfbox}\cr
0.9b & 2022/10/01 & fix \ghissue{2}, improve doc (\ghissue{1})\cr
}}

\vskip-\baselineskip\vskip0pt\relax

\section{Description}

This package fixes various colour leaks one encounters with
the environments from Donald Arseneau's package
\ctanpackage{framed}.  Typically, colour leaks occur if using
|\color| (at top level) inside the environments, or more subtly also when
using |\textcolor| with an argument ending up being split at a
page break.

This latter type of colour leak (or colour disappearance) is the
more challenging one as the fix requires modifications or
replacements not only of some of the \ctanpackage{framed}.sty
macros (such as its |\CustomFBox|, which \colorframed overwrites)
but also to some \LaTeX{} internals, as some environments of
\ctanpackage{framed}.sty rely on usage of |\fbox| or |\colorbox|.
Rather than overwriting internal \LaTeX{} macros such as
|\@frameb@x| or |\color@b@x|, \colorframed simply replaces |\fbox|
and |\colorbox| in the \ctanpackage{framed}.sty environments by
appropriate substitutes.

I am aware \ctanpackage{tcolorbox} package documentation explains at
least one colour issue which looks similar to those fixed
here in \ctanpackage{framed} context, and that the fix overthere uses
an extra colour stack, hence is not \XeLaTeX{} compatible
currently.

The problems are solved here without involving an extra
colour stack, hence the fixes work also with \XeLaTeX.

\section{The environments from \ctanpackage{framed}}

  We refer the reader to \ctanpackage{framed} documentation
  and provide here only a few additional details, particularly
  regarding the `titled-frame' environment as it is described
  in \ctanpackage{framed} documentation more as being a
  template than a user-level finalized environment.  The next
  box gives an example of its use.  It is an environment with
  one mandatory argument which provides the title of the
  frame, which is repeated after a page break with |(cont)|
  appended.  The colours |TFFrameColor| and
  |TFTitleColor| must be defined by user.  
\begin{titled-frame}{A list of the environments from package \ctanpackage{framed}}
  This list indicates which boxing macros are
  used in the original, and their replacement.
% (investigate later why something such as shortverb |#| in
% preamble does not work)
\halign{\bfseries#\hfil&(#\unskip)~\hfil&#\hfil\cr
%
  framed & |\fbox| & Replaced by specialization of own \rlap{\string\CustomFBox.}\cr
%
  oframed & |\CustomFBox| & \colorframed uses a redefined |\CustomFBox|.\cr
%
  titled-frame & |\CustomFBox| & \emph{id.}\cr
%
  shaded & |\colorbox| & Replaced by |\colorframedcolorbox|.\cr
%
  shaded* & |\colorbox| & \emph{id.}\cr
%
  snugshade & |\colorbox| & \emph{id.}\cr
%
  snugshade* & |\colorbox| & \emph{id.}\cr
%
  leftbar & none & This one does not use any boxing macro.\cr
}
\end{titled-frame}
\begin{shaded*}
\begin{footnotesize}
\emph{The current box is an example of \emph{`shaded*'}
    environment; The
    \emph{shadecolor} must have been defined by user.}
\par  To customize
  further usage of `titled-frame' one will need to renew its definition,
  which is left untouched by \colorframed.
  Here is its source from \ctanpackage{framed}.sty: (code and
  comments by Donald Arseneau)% don't ask why the % (TeX bug in my opinion)
\begin{verbatim}
% A particular type of titled frame with continuation marks.  
% Parameter #1 is the title, repeated on each page.
\newenvironment{titled-frame}[1]{%
  \def\FrameCommand{\fboxsep8pt\fboxrule2pt
     \TitleBarFrame{\textbf{#1}}}%
  \def\FirstFrameCommand{\fboxsep8pt\fboxrule2pt
     \TitleBarFrame[$\blacktriangleright$]{\textbf{#1}}}%
  \def\MidFrameCommand{\fboxsep8pt\fboxrule2pt
     \TitleBarFrame[$\blacktriangleright$]{\textbf{#1\ (cont)}}}%
  \def\LastFrameCommand{\fboxsep8pt\fboxrule2pt
     \TitleBarFrame{\textbf{#1\ (cont)}}}%
  \MakeFramed{\advance\hsize-20pt \FrameRestore}}%
%  note: 8 + 2 + 8 + 2 = 20.  Don't use \width because the frame title
%  could interfere with the width measurement.
 {\endMakeFramed}
\end{verbatim}
  This `titled-frame' environment was in effect broken in recent \LaTeX\ which
  has modified how |\smash| behaves (the continuation label created a blank
  line interrupting the framing); \colorframed fixes this infelicity in
  passing.

  One does not need to dive into the details of the macros
  used above to understand intuitively how they are supposed
  to influence the final output.  To modify this output,
  simply redefine this environment with suitable changes.

  There are actually some layout problems which one discovers with a higher
  |\fboxrule| setting such as setting it to |10pt| (see on this the
  \ghissue[repository issue ]{3} and also \ghissue[repository issue ]{4}).  So
  release |0.9b| provides |\colorframedTitleBarFrame|, which can be used as a
  replacement to |\TitleBarFrame|.  Check the source file for some more
  information.  This is provided as an exception that this package should take
  care only of fixing colour problems.

\end{footnotesize}
\end{shaded*}


The aim of \colorframed regarding \ctanpackage{framed} existing
code base is strictly limited to fixing the colour leak issues,
there is not intent to extend the existing environments of
\ctanpackage{framed} with additional capabilities and
customizability.  Two customization macros have been added
though which are described below.


% cf issue #5 on how one uses framed environments such as snugshade
% with such list items
%
% j'utilise enumitem+noitemsep sinon je vois dans la partie ombrée
% de l'espace supplémentaire au début de l'item (peut-être aussi
% lié à l'emploi du package parskip)
\colorlet{shadecolor}{lightgray!25}

% check why topsep influences separation of item 1 and 2
% it shouldn't? hmm... I think framed itself uses \topsep...
\begin{enumerate}[noitemsep,topsep=6pt,font=\normalcolor]
\begin{snugshade}
\item {This item is wrapped in a {`snugshade'}; see the
    \ghissue[repository issue ]{5} for some comments about this.  As for
    {`shaded'} the {shadecolor} must have been defined by user.}
\end{snugshade}

%\color{RawSienna}
\begin{snugshade}
\item
  The |$\blacktriangleright$| used in the `titled-frame' environement
  (which despite its name obeys current text colour setting)
  requires to
  the best of my knowledge loading \ctanpackage{amssymb} or
  some other math symbols package and it is up to user to do it, if
  its usage is kept.
%
  The original environment gives to this continuation label the
  same colour as the frame.  \colorframed adds the
  possibility to customize this colour via suitably defining a
  macro, like this for example:% le % pour éviter un bug lorsqu'un caractère
                               % espace est à la fin d'une ligne quasi-pleine,
                               % je soupçonne bug de TeX que j'ai déjà
                               % rencontré plusieurs fois, ou peut-être ici un
                               % problème du \trivlist de verbatim
\begin{verbatim}
\renewcommand\colorframedTFconlabcolorcommand{\color{purple}}
\end{verbatim}
\end{snugshade}
\end{enumerate}

\begin{framed}
  This is an example of usage of the environment `framed'.

  This environment allows customization of the border width
  and of the separation with contents, via |\FrameRule| and
  |\FrameSep|, but not of the colour of the border.  The
  \colorframed version adds this possibility: it is simply a
  matter of redefining the |\colorframedbordercolorcommand|
  macro, which defaults to |\normalcolor|.

\footnotesize (|\color{blue}| in source)
\normalsize
\color{blue}
  So the current frame was configured using:
\begin{verbatim}
\setlength{\FrameRule}{5pt}
\setlength{\FrameSep}{9pt}
\renewcommand\colorframedbordercolorcommand{\color{red!20}}
\end{verbatim}
\begin{footnotesize}\normalcolor
  (the above verbatim sets its own colour, and we have switched
  back to |\normalcolor| here)

  The length |\FrameSep| influences also `oframed', `shaded', and `shaded*',
  but `snugshade' and `snugshade*' employ |\fboxsep| rather.  As per `titled-frame'
  it uses a hard-coded 8pt separation from contents (see its definition).

  |\FrameRule| influences `framed' and `oframed' but not
  `titled-frame' which uses a hard-coded 2pt for its border width.\par
\end{footnotesize}
  The text colour induced from a |\color{blue}|
  will not leak out to the frame or to the text following this
  environment, even in case of a pagebreak.
\end{framed}

\section{TODO}

The author has developed based upon usage of \ctanpackage{pict2e}
breakable boxes with round corners, background colour, optional
shadow (possibly inset), and other goodies and is planning on
incorporating this environment into the package.
%
Of course, it will remain limited in comparison to the fully
customizable boxes provided by package \ctanpackage{tcolorbox}
but our testing showed significant speed-up in build time, which
may matter for long documents.

% Hopefully this addition will be done when time will permit.

\thispagestyle{empty}
\enlargethispage{2\baselineskip}

%\colorlet{shadecolor}{lightgray!50}
\footnotesize
\begin{snugshade}
  After initial release made it to CTAN on
  2022/09/22 I became aware of \ctanpackage{longfbox} which
  provides already such \ctanpackage{pict2e} breakable boxes with
  rounded corners (even elliptical arcs), and furthermore with a
  CSS-like interface which is exactly what I had done on my side
  too... I need to check more \ctanpackage{longfbox} before a
  decision is made here!  Perhaps it will be better to keep
  \colorframed as it is currently and produce another package for
  extras such as \ctanpackage{pict2e}-based boxes or a key-value
  interface to `inline' or `display' box macros and environments.
\end{snugshade}
\centerline{\hrulefill documentation ends here\hrulefill}
\end{document}