\documentclass[a4paper,dvipdfmx,11pt]{article}
\usepackage[T1]{fontenc}
\usepackage[straightquotes,ttzdefault]{newtxtt}
\usepackage{colorframed}
\title{The colorframed package\thanks{Release 0.9 of 2022/09/22}}
\author{Jean-Fran√ßois B.}
\date{September 22, 2022}
\begin{document}
\maketitle
% This package fixes various colour leaks one encounters using
% framed.sty environments.  The most challenging colour leaks
% arise at pagebreaks and their fixes require modifications
% not only fo some framed.sty macros but also to some LaTeX
% internal macros which are involved with \fbox and \colorbox.
%
% I am aware tcolorbox.sty package documentation explains at
% least one colour issue which looks similar to those fixed
% here in framed.sty context, and that the fix overthere uses
% an extra colour stack, hence is not xelatex compatible
% currently.
%
% The problems are solved here without involving an extra
% colour stack, hence they work also with xelatex.
%
% The analysis and original workarounds for using framed.sty
% with colours were developed by me in some contributions I made
% to the Sphinx project (https://github.com/sphinx-doc/sphinx)
% and I am transferring here the general idea.
%
% The key thing is that the boxes handled by framed.sty may
% contain isolated colour push or colour pop.  We must make
% sure an isolated colour push, if followed by colour changes,
% is always followed by paired ones, and never by a colour pop
% from a colour command originated "prior".
%
% TODO: transfer also the breakable box environment based on pict2e
% and allowing rounded corners and shadows developped overthere.
%
% Here is a list of the framed.sty environments and the boxing
% macros they are based upon:
%
%   framed     - \fbox         (the colorframed variant will use \CustomFBox)
%   oframed      - \CustomFBox (colorframed has its own \CustomFbox)
%   titled-frame - \CustomFbox
%   shaded     - \colorbox     (replaced by \colorframedcolorbox)
%   shaded*    - \colorbox     (idem)
%   snugshade  - \colorbox     (idem)
%   snugshade* - \colorbox     (idem)
%   leftbar    - <none>
%
% Notes:
% - The \fbox would need a rewrite of \@frameb@x but we rather replaced
%   its usage by a specialization of our custom \CustomFBox.
% - The original titled-frame output is impacted by LaTeX having made
%   \smash do \leavevmode; we fix this as part of the rewrite of
%   \TitleBarFrame which is needed anyhow to fix colour problems.
% - The titled-frame environment uses \blacktriangleright which afaik
%   requires amssymb, but it is up to user to load amssymb.
%

\end{document}